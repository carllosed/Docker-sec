FROM alpine:3.20
RUN apk update && apk upgrade
RUN apk add --no-cache build-base git re2c libxml2-dev zlib-dev nginx wget autoconf bison re2c curl-dev libpng-dev libjpeg-turbo-dev freetype-dev oniguruma-dev libxslt-dev libffi-dev openssl-dev sqlite-dev
RUN git clone https://github.com/php/php-src
RUN cd /php-src && git checkout php-7.1.33
RUN cd /php-src && ./buildconf --force && ./configure --enable-fpm --without-pear && make -j4 && make install
COPY php-fpm.conf /usr/local/etc/php-fpm.conf
COPY nginx.conf /etc/nginx/nginx.conf
COPY script.php /usr/share/nginx/html/script.php
COPY entrypoint /entrypoint
RUN chmod +x /entrypoint
RUN adduser -D -G www-data www-data
# RUN rm -f /php-src/sapi/fpm/fpm/fpm_main.c
# COPY fpm_main.c /php-src/sapi/fpm/fpm/fpm_main.c
# RUN rm -f /php-src/main/fastcgi.c
# COPY fastcgi.c /php-src/main/fastcgi.c
# RUN cd /php-src && make -j4 && make install
CMD /entrypoint
